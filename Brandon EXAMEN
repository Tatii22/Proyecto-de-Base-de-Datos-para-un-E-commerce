DELIMITER $$

CREATE FUNCTION fn_CalcularRentabilidadProducto(p_id_producto INT) 
RETURNS DECIMAL(10,2)
DETERMINISTIC
BEGIN
DECLARE v_costo DECIMAL(10,2);
DECLARE v_total_rentabilidad DECIMAL(10,2);
SELECT costo 
INTO v_costo 
FROM productos
WHERE id_producto = p_id_producto;

SELECT 
    SUM((dv.precio_unitario_congelado - v_costo) * dv.cantidad)
INTO v_total_rentabilidad
FROM detalle_ventas dv
WHERE dv.id_producto = p_id_producto;

RETURN IFNULL(v_total_rentabilidad, 0);
END $$

DELIMITER;
SELECT fn_CalcularRentabilidadProducto (5) AS Rentabilidad;
